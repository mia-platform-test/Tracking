apiVersion: v1
data:
  cds.json: '{"resources":[]}'
  lds.json: '{"resources":[{"@type":"type.googleapis.com/envoy.config.listener.v3.Listener","name":"frontend","address":{"socket_address":{"protocol":"TCP","address":"0.0.0.0","port_value":8080}},"filter_chains":[{"filters":[{"name":"envoy.filters.network.http_connection_manager","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager","stat_prefix":"frontend_ingress_http","http2_protocol_options":{"connection_keepalive":{"interval":"5s","timeout":"45s"}},"use_remote_address":true,"xff_num_trusted_hops":1,"skip_xff_append":false,"request_headers_timeout":"30s","stream_idle_timeout":"60s","access_log":[{"name":"envoy.access_loggers.stream","filter":{"not_health_check_filter":{}},"typed_config":{"@type":"type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog","log_format":{"json_format":{"time":"%START_TIME%","remoteAddress":"%REQ(X-Real-IP)%","remoteHostname":"%REQ(HOST)%","requestMethod":"%REQ(:METHOD)%","originalRequestPath":"%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%","requestURL":"%REQ(:PATH)%","requestProtocol":"%PROTOCOL%","userAgent":"%REQ(USER-AGENT)%","statusCode":"%RESPONSE_CODE%","responseSize":"%BYTES_SENT%","responseTime":"%DURATION%","reqId":"%REQ(X-REQUEST-ID)%"}}}}],"local_reply_config":{"mappers":[{"filter":{"and_filter":{"filters":[{"status_code_filter":{"comparison":{"op":"EQ","value":{"default_value":405,"runtime_key":"key_b"}}}},{"header_filter":{"header":{"name":"Content-Type","string_match":{"exact":"application/json"}}}}]}},"status_code":405,"body_format_override":{"json_format":{"error":"METHOD NOT ALLOWED","path":"%REQ(:PATH)%","method":"%REQ(:METHOD)%"},"content_type":"application/json"},"headers_to_add":[{"header":{"key":"Content-Type","value":"application/json"},"append":false}]},{"filter":{"and_filter":{"filters":[{"status_code_filter":{"comparison":{"op":"EQ","value":{"default_value":404,"runtime_key":"key_b"}}}},{"header_filter":{"header":{"name":"Content-Type","string_match":{"exact":"application/json"}}}}]}},"status_code":404,"body_format_override":{"json_format":{"error":"NOT FOUND","path":"%REQ(:PATH)%","method":"%REQ(:METHOD)%"},"content_type":"application/json"},"headers_to_add":[{"header":{"key":"Content-Type","value":"application/json"},"append":false}]},{"filter":{"and_filter":{"filters":[{"status_code_filter":{"comparison":{"op":"EQ","value":{"default_value":403,"runtime_key":"key_b"}}}},{"header_filter":{"header":{"name":"Content-Type","string_match":{"exact":"application/json"}}}}]}},"status_code":403,"body_format_override":{"json_format":{"error":"FORBIDDEN","path":"%REQ(:PATH)%","method":"%REQ(:METHOD)%"},"content_type":"application/json"},"headers_to_add":[{"header":{"key":"Content-Type","value":"application/json"},"append":false}]},{"filter":{"and_filter":{"filters":[{"status_code_filter":{"comparison":{"op":"EQ","value":{"default_value":401,"runtime_key":"key_b"}}}},{"header_filter":{"header":{"name":"Content-Type","string_match":{"exact":"application/json"}}}}]}},"status_code":401,"body_format_override":{"json_format":{"error":"UNAUTHORIZED","path":"%REQ(:PATH)%","method":"%REQ(:METHOD)%"},"content_type":"application/json"},"headers_to_add":[{"header":{"key":"Content-Type","value":"application/json"},"append":false}]},{"filter":{"status_code_filter":{"comparison":{"op":"EQ","value":{"default_value":401,"runtime_key":"key_b"}}}},"status_code":401,"body_format_override":{"text_format_source":{"inline_string":"UNAUTHORIZED %REQ(:METHOD)% %REQ(:PATH)%"},"content_type":"text/plain"},"headers_to_add":[{"header":{"key":"Content-Type","value":"text/plain"},"append":false}]},{"filter":{"status_code_filter":{"comparison":{"op":"EQ","value":{"default_value":403,"runtime_key":"key_b"}}}},"status_code":403,"body_format_override":{"text_format_source":{"inline_string":"FORBIDDEN %REQ(:METHOD)% %REQ(:PATH)%"},"content_type":"text/plain"},"headers_to_add":[{"header":{"key":"Content-Type","value":"text/plain"},"append":false}]},{"filter":{"status_code_filter":{"comparison":{"op":"EQ","value":{"default_value":404,"runtime_key":"key_b"}}}},"status_code":404,"body_format_override":{"text_format_source":{"inline_string":"NOT FOUND %REQ(:METHOD)% %REQ(:PATH)%"},"content_type":"text/plain"},"headers_to_add":[{"header":{"key":"Content-Type","value":"text/plain"},"append":false}]},{"filter":{"status_code_filter":{"comparison":{"op":"EQ","value":{"default_value":405,"runtime_key":"key_b"}}}},"status_code":405,"body_format_override":{"text_format_source":{"inline_string":"METHOD NOT ALLOWED %REQ(:METHOD)% %REQ(:PATH)%"},"content_type":"text/plain"},"headers_to_add":[{"header":{"key":"Content-Type","value":"text/plain"},"append":false}]}]},"route_config":{"name":"frontend_route","request_headers_to_add":[{"header":{"key":"X-Forwarded-Host","value":"%REQ(HOST)%"},"append":false},{"header":{"key":"Scheme","value":"%REQ(X-FORWARDED-PROTO)%"},"append":false},{"header":{"key":"X-Real-IP","value":"%REQ(X-ENVOY-EXTERNAL-ADDRESS)%"},"append":false},{"header":{"key":"X-Original-URI","value":"%REQ(:path)%"},"append":false},{"header":{"key":"Original-Request-Uri","value":"%REQ(:path)%"},"append":false},{"header":{"key":"Original-Request-Method","value":"%REQ(:method)%"},"append":false},{"header":{"key":"miauserid","value":"%DYNAMIC_METADATA([\"envoy.filters.http.ext_authz\",\"mia-userid\"])%"},"append":false},{"header":{"key":"miausergroups","value":"%DYNAMIC_METADATA([\"envoy.filters.http.ext_authz\",\"mia-groups\"])%"},"append":false},{"header":{"key":"client-type","value":"%DYNAMIC_METADATA([\"mia.metadata\",\"client_type\"])%"},"append":false},{"header":{"key":"isbackoffice","value":"%DYNAMIC_METADATA([\"mia.metadata\",\"isbackoffice\"])%"},"append":false},{"header":{"key":"miauserproperties","value":"%DYNAMIC_METADATA([\"envoy.filters.http.ext_authz\",\"mia-userproperties\"])%"},"append":false}],"response_headers_to_add":[{"header":{"key":"X-Content-Type-Options","value":"nosniff"},"append":false},{"header":{"key":"X-Frame-Options","value":"SAMEORIGIN"},"append_action":"ADD_IF_ABSENT"},{"header":{"key":"X-Download-Options","value":"noopen"},"append":false},{"header":{"key":"Referrer-Policy","value":"strict-origin-when-cross-origin"},"append":false}],"virtual_hosts":[{"name":"frontend_service","domains":["*"],"rate_limits":{"actions":[{"remote_address":{}}]},"routes":[]}]},"http_filters":[{"name":"envoy.filters.http.local_ratelimit","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit","stat_prefix":"http_local_rate_limiter"}},{"name":"envoy.filters.http.compressor","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor","response_direction_config":{"common_config":{"min_content_length":1024,"content_type":["text/plain","text/xml","text/css","text/javascript","application/json","application/xml","application/javascript","application/x-javascript","application/vnd.ms-fontobject","application/x-font-ttf","application/x-font-opentype","application/x-font-truetype","font/eot","font/otf","font/opentype","image/svg+xml","image/vnd.microsoft.icon"]},"disable_on_etag_header":true},"request_direction_config":{"common_config":{"enabled":{"default_value":false,"runtime_key":"request_compressor_enabled"}}},"compressor_library":{"name":"text_optimized","typed_config":{"@type":"type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip","memory_level":5,"window_bits":12,"compression_level":"DEFAULT_COMPRESSION","compression_strategy":"DEFAULT_STRATEGY"}}}},{"name":"envoy.filters.http.compressor","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor","response_direction_config":{"common_config":{"min_content_length":1024,"content_type":["text/plain","text/xml","text/css","text/javascript","application/json","application/xml","application/javascript","application/x-javascript","application/vnd.ms-fontobject","application/x-font-ttf","application/x-font-opentype","application/x-font-truetype","font/eot","font/otf","font/opentype","image/svg+xml","image/vnd.microsoft.icon"]},"disable_on_etag_header":true},"request_direction_config":{"common_config":{"enabled":{"default_value":false,"runtime_key":"request_compressor_enabled"}}},"compressor_library":{"name":"text_optimized","typed_config":{"@type":"type.googleapis.com/envoy.extensions.compression.brotli.compressor.v3.Brotli","window_bits":10}}}},{"name":"decompressor","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.decompressor.v3.Decompressor","decompressor_library":{"name":"basic","typed_config":{"@type":"type.googleapis.com/envoy.extensions.compression.gzip.decompressor.v3.Gzip","window_bits":15}}}},{"name":"decompressor","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.decompressor.v3.Decompressor","decompressor_library":{"name":"basic","typed_config":{"@type":"type.googleapis.com/envoy.extensions.compression.brotli.decompressor.v3.Brotli"}}}},{"name":"envoy.filters.http.health_check","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.health_check.v3.HealthCheck","pass_through_mode":false,"headers":[{"name":":path","string_match":{"exact":"/healthz"}}]}},{"name":"envoy.filters.http.buffer","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.buffer.v3.Buffer","max_request_bytes":1000000000}},{"name":"envoy.filters.http.header_to_metadata","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.header_to_metadata.v3.Config","request_rules":[{"header":"client-key","on_header_present":{"metadata_namespace":"mia.metadata","key":"client_key","type":"STRING"},"on_header_missing":{"metadata_namespace":"mia.metadata","key":"client_key","value":"missing","type":"STRING"},"remove":false},{"header":"secret","on_header_present":{"metadata_namespace":"mia.metadata","key":"client_key","type":"STRING"},"remove":false},{"cookie":"mia_client_key","on_header_present":{"metadata_namespace":"mia.metadata","key":"client_key","type":"STRING"},"remove":false}]}},{"name":"envoy.filters.http.lua","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua","inline_code":"\nfunction envoy_on_request(request_handle)\n  \n  key_type_map = {\n    [\"missing\"]={\"\", \"unsecreted\"}\n  }\n  key = request_handle:streamInfo():dynamicMetadata():get(\"mia.metadata\")[\"client_key\"]\n  \n  if (key_type_map[key] ~= nil)\n  then\n    request_handle:streamInfo():dynamicMetadata():set(\"mia.metadata\", \"client_type\", key_type_map[key][1])\n    request_handle:streamInfo():dynamicMetadata():set(\"mia.metadata\", \"secret_resolution\", key_type_map[key][2])\n  else\n    request_handle:streamInfo():dynamicMetadata():set(\"mia.metadata\", \"client_type\", \"\")\n    request_handle:streamInfo():dynamicMetadata():set(\"mia.metadata\", \"secret_resolution\", \"wrong\")\n  end\nend\n"}},{"name":"envoy.filters.http.rbac","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBAC","rules":{"action":"DENY","policies":{"wrong":{"permissions":[{"metadata":{"filter":"mia.metadata","path":[{"key":"secret_resolution"}],"value":{"string_match":{"exact":"wrong"}}}}],"principals":[{"any":true}]}}}}},{"name":"envoy.filters.http.router","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.router.v3.Router"}}]}}]}]}]}'
  envoy.json: '{"node":{"cluster":"mia-api-gateway","id":"mia-api-gateway-id"},"dynamic_resources":{"lds_config":{"resource_api_version":"V3","path":"/etc/envoy/lds.json"},"cds_config":{"resource_api_version":"V3","path":"/etc/envoy/cds.json"}},"layered_runtime":{"layers":[{"name":"static_layer","static_layer":{"overload":{"global_downstream_max_connections":4096}}}]},"admin":{"address":{"socket_address":{"protocol":"TCP","address":"0.0.0.0","port_value":9901}}}}'
kind: ConfigMap
metadata:
  name: api-gateway-envoy-config
  annotations:
    mia-platform.eu/creation-user: api-console
    mia-platform.eu/version: 14.1.0-alpha.0
  labels:
    app.kubernetes.io/part-of: tracking
    app.kubernetes.io/managed-by: mia-platform
    mia-platform.eu/stage: '{{STAGE_TO_DEPLOY}}'
    mia-platform.eu/tenant: c1d106ff-4716-49a1-88e2-940b21705986
